# Задача: Исправление поиска адреса по клику (Mapbox Reverse Geocoding)

## 1. Что я пытался сделать (Суть проблемы)
Пользователь кликает на карту, чтобы выбрать точку (Склад, Офис).
**Проблема:**
1. Mapbox часто не находит точный дом (номер дома), если кликнуть чуть мимо или если дом не подписан в "русском" слое карты (хотя он есть в английском/локальном).
2. При клике иногда возвращалась ошибка "Карта не вернула данных", потому что мы слишком строго фильтровали результаты (искали только `address` на русском языке).
3. Когда Mapbox возвращал город по-английски ("Almaty"), он не совпадал с нашим списком городов ("Алматы"), и поле города сбрасывалось.

**Моя цель была:**
Сделать "умный" поиск, который:
1. Ищет сначала точный адрес (дом) **без языковых ограничений** (чтобы найти "157A" даже если он записан как "Gagarina St, 157A").
2. Если точный дом не найден — ищет хотя бы **Район** или **Город**, чтобы не пугать ошибкой "Нет данных".
3. Если Mapbox прислал "Almaty" или "Apple City" — программно превращать это в наш "Алматы" для корректного выбора в выпадающем списке.

---

## 2. Промпт для другого чата (скопируйте и отправьте)

```text
У меня есть Next.js проект с Ant Design.
Файл: apps/web/src/app/company/locations/page.tsx

Мне нужно переписать функцию `handleMapSelect`, которая срабатывает при клике на карту (Mapbox).
Сейчас она работает плохо: часто пишет "Адрес не найден" или не выбирает город.

**Требования к функции:**

1. **Двухэтапный поиск (Fallback):**
   - Сначала сделай запрос к Mapbox API (`mapbox.places`) с типами `types=address,poi` (поиск конкретных зданий) и лимитом 5. Язык НЕ указывай (пусть ищет на всех языках).
   - Если результат пустой (массив `features` пуст) — сделай второй запрос с типами `types=place,locality,neighborhood` (поиск города/района), чтобы мы нашли хотя бы город.

2. **Обработка города (City Matching):**
   - Полученный от карты город (например, "Almaty" или "Alma-Ata") нужно найти в моем массиве `cities` (у них поле `.name`).
   - Сравнение должно быть **нечувствительным к регистру** (LowerCase).
   - Важно: Добавь хардкодинг-проверку: если карта вернула "Almaty" или "Alma-Ata", это должно матчиться с городом "Алматы" в базе.

3. **Заполнение адреса:**
   - Если найден точный адрес (с номером дома) — запиши его в стейт `setAddressValue`.
   - Если найден только город/район — в стейт `addressValue` ничего писать не надо (или можно написать район), но обязательно выведи `message.info`, что "Город определен, введите улицу вручную". Не показывай ошибку, если найден хотя бы город.

**Вот текущий код компонента (упрощенно), вставь туда исправленную функцию:**

const handleMapSelect = async (latitude: number, longitude: number) => {
    setLat(latitude);
    setLng(longitude);
    form.setFieldsValue({ latitude, longitude });

    // ... ТВОЙ КОД ЗДЕСЬ ...
    // Используй fetch для запроса к https://api.mapbox.com/geocoding/v5/mapbox.places/...
}
```
